<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Professeur ‚Äì √âvaluation Plans d'Affaires</title>
    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî¬†STYLES¬†(SANS CHANGEMENT MAJEUR) ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <style>
        /* ... m√™me feuille de style que pr√©c√©demment (inchang√©e) ... */
    </style>
</head>
<body>
    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî¬†ZONE DE CONNEXION ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <div class="login-container" id="loginContainer">
        <div class="login-panel">
            <div class="login-header">
                <h1>üë®‚Äçüè´ Professeur</h1>
                <p>Acc√®s au tableau de bord d'√©valuation</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email institutionnel&nbsp;:</label>
                    <input type="email" id="email" name="email" required placeholder="professeur@university.ca">
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe&nbsp;:</label>
                    <input type="password" id="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="login-btn">üîê Se connecter</button>
            </form>
            <div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:12px;font-size:.9em;color:#666;">
                <strong>Comptes de d√©mo (si API non dispo)&nbsp;:</strong><br>
                marie.dubois@university.ca / prof123<br>
                jean.martin@university.ca / prof123
            </div>
        </div>
    </div>

    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî¬†DASHBOARD ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="dashboard-header">
            <div class="professor-info">
                <h2 id="professorName"></h2>
                <p id="professorCourse"></p>
            </div>
            <button class="logout-btn" onclick="logout()" aria-label="D√©connexion">üö™ D√©connexion</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-number" id="totalSubmissions">0</div><div class="stat-label">Plans soumis</div></div>
            <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-number" id="completedAnalyses">0</div><div class="stat-label">Analyses termin√©es</div></div>
            <div class="stat-card"><div class="stat-icon">‚è≥</div><div class="stat-number" id="pendingAnalyses">0</div><div class="stat-label">En cours d'analyse</div></div>
            <div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-number" id="averageScore">0</div><div class="stat-label">Score moyen</div></div>
        </div>

        <div class="main-panel">
            <div class="panel-header">
                <div class="panel-title">üìä Gestion des Plans d'Affaires</div>
                <div class="controls">
                    <input type="text" class="search-box" placeholder="üîç Rechercher un √©tudiant..." id="searchBox">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">Tous les statuts</option>
                        <option value="completed">Termin√©</option>
                        <option value="processing">En cours</option>
                        <option value="pending">En attente</option>
                    </select>
                    <button class="export-btn" onclick="exportToCSV()" aria-label="Exporter en CSV">üìä Export CSV</button>
                </div>
            </div>
            <div id="studentsTableContainer"></div>
        </div>
    </div>

    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî¬†MODAL RAPPORT ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <div class="report-header">
                <h2>üìã Rapport d'Analyse D√©taill√©</h2>
                <button class="close-btn" onclick="closeReportModal()" aria-label="Fermer le rapport">‚ùå</button>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî¬†SCRIPT PRINCIPAL ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <script>
        /* -----------------------------------------------------------
         * VARIABLES GLOBALES
         * ---------------------------------------------------------*/
        let studentsData = [];
        let sortColumn   = null;
        let sortDirection = 'asc';

        /* -----------------------------------------------------------
         * AUTHENTIFICATION
         * ---------------------------------------------------------*/
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email    = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/auth/login', {
                    method : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body   : JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Email ou mot de passe incorrect');
                }

                /* ‚Äî‚Äî‚Äî¬†IMPORTANT¬†: on r√©cup√®re le JSON ICI ‚Äî‚Äî‚Äî */
                const data = await response.json();

                /* ‚Äî‚Äî‚Äî¬†SAUVEGARDE DU TOKEN ‚Äî‚Äî‚Äî */
                localStorage.setItem('professorToken', data.access_token);
                localStorage.setItem('professorInfo',  JSON.stringify(data.professor));

                /* ‚Äî‚Äî‚Äî¬†MISE √Ä JOUR UI¬†‚Äî DISSIMULER LE LOGIN ‚Äî‚Äî‚Äî */
                document.getElementById('loginContainer').style.display   = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                document.getElementById('professorName').textContent  = data.professor?.name   || email;
                document.getElementById('professorCourse').textContent = data.professor?.course || 'Cours';

                await initializeDashboard();
            } catch (err) {
                console.error('√âchec de la connexion¬†:', err);
                alert('Erreur de connexion¬†: ' + err.message);
            }
        });

        /* -----------------------------------------------------------
         * INITIALISATION DU DASHBOARD (FAKE DATA SI PAS DE JWT)
         * ---------------------------------------------------------*/
        async function initializeDashboard() {
            try {
                const token = localStorage.getItem('professorToken');
                /* ‚Äî fake data si pas de token ‚Äî */
                if (!token) {
                    studentsData = /* ‚Ä¶ m√™me tableau simul√© qu'avant ‚Ä¶ */ [];
                    updateStats();
                    renderStudentsTable();
                    setupEventListeners();
                    return;
                }

                const response = await fetch('/professor/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erreur lors de la r√©cup√©ration des donn√©es');

                const data = await response.json();
                // ‚Ä¶ mise √† jour stats + studentsData ‚Ä¶
                renderStudentsTable();
                setupEventListeners();
            } catch (err) {
                console.error('Erreur lors du chargement du dashboard¬†:', err);
                updateStats();
                renderStudentsTable();
                setupEventListeners();
            }
        }

        /* -----------------------------------------------------------
         * D√âCONNEXION
         * ---------------------------------------------------------*/
        function logout() {
            localStorage.removeItem('professorToken');
            localStorage.removeItem('professorInfo');
            document.getElementById('loginContainer').style.display   = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
            studentsData = [];
        }

        /* -----------------------------------------------------------
         * RAPPORT D√âTAILL√â (VIEWREPORT)
         * ---------------------------------------------------------*/
        async function viewReport(studentId) {
            try {
                const token = localStorage.getItem('professorToken');
                // ‚Ä¶ m√™me logique qu'avant ‚Ä¶
            } catch (err) {
                alert('Erreur lors de la r√©cup√©ration du rapport¬†: ' + err.message);
            }
        }

        /* -----------------------------------------------------------
         * RENDU TABLEAU, TRI, FILTRES, ETC.
         * (fonctions identiques aux originales, simplement d√©plac√©es)
         * ---------------------------------------------------------*/
        // ‚Ä¶ updateStats, renderStudentsTable, sortTable, getFilteredData,
        //    setupEventListeners, formatDate, formatTime, getStatusText,
        //    generateDetailedReport, closeReportModal, copyEmail, viewStatus,
        //    exportToCSV ‚Ä¶

    </script>
</body>
</html>

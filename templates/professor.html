<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Professeur - √âvaluation Plans d'Affaires</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 50px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); max-width: 450px; width: 100%; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-header h1 { font-size: 2.5em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-weight: 800; }
        .login-header p { color: #666; font-size: 1.1em; }
        .dashboard-container { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .dashboard-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; align-items: center; }
        .professor-info h2 { font-size: 2em; color: #333; margin-bottom: 5px; font-weight: 700; }
        .professor-info p { color: #666; font-size: 1.1em; }
        .logout-btn { background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 71, 87, 0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); text-align: center; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 25px 70px rgba(0,0,0,0.15); }
        .stat-icon { font-size: 3em; margin-bottom: 15px; opacity: 0.8; }
        .stat-number { font-size: 2.5em; font-weight: 800; color: #4facfe; margin-bottom: 10px; }
        .stat-label { color: #666; font-weight: 600; font-size: 1.1em; }
        .main-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .panel-title { font-size: 1.8em; font-weight: 700; color: #333; display: flex; align-items: center; gap: 15px; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .search-box { padding: 12px 20px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1em; width: 250px; transition: all 0.3s ease; }
        .search-box:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .filter-select { padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 1em; background: white; cursor: pointer; transition: all 0.3s ease; }
        .filter-select:focus { outline: none; border-color: #4facfe; }
        .export-btn { background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%); color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3); }
        .students-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .students-table th { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 18px 15px; text-align: left; font-weight: 700; color: #333; border-bottom: 2px solid #dee2e6; font-size: 0.95em; }
        .students-table td { padding: 18px 15px; border-bottom: 1px solid #e9ecef; transition: all 0.3s ease; }
        .students-table tr:hover { background: linear-gradient(135deg, #f8faff 0%, #f0f6ff 100%); }
        .sortable-header { cursor: pointer; transition: all 0.3s ease; position: relative; user-select: none; }
        .sortable-header:hover { background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); color: #4facfe; }
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600; text-align: center; min-width: 120px; display: inline-block; }
        .status-completed { background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); color: #2E7D32; border: 1px solid #4CAF50; }
        .status-processing { background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); color: #F57C00; border: 1px solid #FF9800; }
        .status-pending { background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); color: #666; border: 1px solid #bbb; }
        .action-btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s ease; margin-right: 8px; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(79, 172, 254, 0.3); }
        .action-btn.secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        .action-btn.secondary:hover { box-shadow: 0 6px 15px rgba(108, 117, 125, 0.3); }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="email"], input[type="password"] { width: 100%; padding: 16px; border: 2px solid #e1e5e9; border-radius: 16px; font-size: 1em; transition: all 0.3s ease; background: rgba(255,255,255,0.8); }
        input[type="email"]:focus, input[type="password"]:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1); background: white; }
        .login-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 40px; border-radius: 16px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; width: 100%; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4); }
        .report-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .report-content { background: white; border-radius: 24px; padding: 40px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 30px 80px rgba(0,0,0,0.3); }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .close-btn { background: #ff4757; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.5em; margin-bottom: 10px; color: #333; }
        .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .quick-stat { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid #dee2e6; }
        .quick-stat-number { font-size: 2em; font-weight: 800; color: #4facfe; margin-bottom: 8px; }
        .quick-stat-label { color: #666; font-weight: 600; font-size: 0.9em; }
        @media (max-width: 768px) { .dashboard-header { flex-direction: column; gap: 20px; text-align: center; } .controls { flex-direction: column; width: 100%; } .search-box { width: 100%; } .students-table { font-size: 0.9em; } .students-table th, .students-table td { padding: 12px 8px; } }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-panel">
            <div class="login-header">
                <h1>üë®‚Äçüè´ Professeur</h1>
                <p>Acc√®s au tableau de bord d'√©valuation</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email institutionnel :</label>
                    <input type="email" id="email" name="email" required placeholder="professeur@university.ca">
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe :</label>
                    <input type="password" id="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="login-btn">üîê Se connecter</button>
            </form>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContainer">
        <div class="dashboard-header">
            <div class="professor-info">
                <h2 id="professorName"></h2>
                <p id="professorCourse"></p>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-number" id="totalSubmissions">0</div>
                <div class="stat-label">Plans soumis</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="completedAnalyses">0</div>
                <div class="stat-label">Analyses termin√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-number" id="pendingAnalyses">0</div>
                <div class="stat-label">En cours d'analyse</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-number" id="averageScore">0</div>
                <div class="stat-label">Score moyen</div>
            </div>
        </div>
        
        <div class="main-panel">
            <div class="panel-header">
                <div class="panel-title">üìä Gestion des Plans d'Affaires</div>
                <div class="controls">
                    <input type="text" class="search-box" placeholder="üîç Rechercher un √©tudiant..." id="searchBox">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">Tous les statuts</option>
                        <option value="completed">Termin√©</option>
                        <option value="processing">En cours</option>
                        <option value="pending">En attente</option>
                    </select>
                    <button class="export-btn" onclick="exportToCSV()">üìä Export CSV</button>
                </div>
            </div>
            <div id="studentsTableContainer"></div>
        </div>
    </div>

    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <div class="report-header">
                <h2>üìã Rapport d'Analyse D√©taill√©</h2>
                <button class="close-btn" onclick="closeReportModal()">‚ùå</button>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
    // ==========================================================
    // VARIABLES GLOBALES
    // ==========================================================
    let studentsData = [];
    let sortColumn = null;
    let sortDirection = 'asc';

    // ==========================================================
    // GESTION DE L'AUTHENTIFICATION ET INITIALISATION
    // ==========================================================

    // G√®re le formulaire de connexion
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Email ou mot de passe incorrect');
            }
            
            const data = await response.json();
            
            localStorage.setItem('professorToken', data.access_token);
            localStorage.setItem('professorInfo', JSON.stringify(data.professor || {}));
            
            updateUIAfterLogin(data.professor);
            await initializeDashboard();
            
        } catch (error) {
            console.error('Erreur de connexion:', error);
            alert('Erreur de connexion: ' + error.message);
        }
    });

    // Met √† jour l'interface apr√®s une connexion r√©ussie
    function updateUIAfterLogin(professorInfo) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('dashboardContainer').style.display = 'block';
        document.getElementById('professorName').textContent = professorInfo?.name || 'Professeur';
        document.getElementById('professorCourse').textContent = professorInfo?.course || 'Entrepreneuriat';
    }

    // Fonction principale qui charge les donn√©es du tableau de bord
    async function initializeDashboard() {
        const container = document.getElementById('studentsTableContainer');
        try {
            const token = localStorage.getItem('professorToken');
            if (!token) {
                logout();
                return;
            }
            
            const response = await fetch('/api/professor/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Erreur lors du chargement des donn√©es');
            
            const submissionsFromServer = await response.json();
            
            // On "traduit" les donn√©es du serveur pour qu'elles correspondent √† votre variable `studentsData`
            studentsData = submissionsFromServer.map(submission => ({
                id: submission.id,
                name: submission.student_name,
                email: submission.student_email,
                project: submission.project_title,
                status: submission.status,
                submissionDate: submission.submission_date,
                score: submission.score,
                lastActivity: submission.submission_date 
            }));
            
            updateStats();
            renderStudentsTable();
            setupEventListeners();
            
        } catch (error) {
            console.error('Erreur lors du chargement du dashboard:', error);
            container.innerHTML = `<div class="empty-state"><h3>Erreur de chargement</h3><p>${error.message}</p></div>`;
        }
    }

    // ==========================================================
    // GESTION DES RAPPORTS ET DE LA MODALE
    // ==========================================================

    // Affiche le rapport d'analyse dans la modale
    async function viewReport(studentId) {
        const token = localStorage.getItem('professorToken');
        if (!token) {
            alert("Session expir√©e, veuillez vous reconnecter.");
            return;
        }

        const reportModal = document.getElementById('reportModal');
        const reportContent = document.getElementById('reportContent');
        
        reportContent.innerHTML = '<div style="text-align:center; padding: 2rem;">Chargement du rapport...</div>';
        reportModal.style.display = 'flex';

        try {
            const response = await fetch(`/api/analysis/${studentId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Impossible de charger le rapport.');
            }
            const analysis = await response.json();
            reportContent.innerHTML = analysis.report_html;
        } catch (error) {
            console.error("Erreur chargement du rapport:", error);
            reportContent.innerHTML = `<div style="text-align:center; padding: 2rem; color:red;">${error.message}</div>`;
        }
    }

    // Affiche une alerte pour les statuts en cours
    function viewStatus(studentId) {
        const student = studentsData.find(s => s.id === studentId);
        if (student) {
            alert(`‚è≥ Statut de l'analyse\n\n√âtudiant: ${student.name}\nProjet: ${student.project}\n\nL'analyse par IA est en cours. Le rapport sera disponible dans quelques minutes.`);
        }
    }

    // Ferme la modale du rapport
    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }

    // ==========================================================
    // FONCTIONS UTILITAIRES (RENDU, TRI, FILTRE, ETC.)
    // ==========================================================

    function updateStats() {
        const completed = studentsData.filter(s => s.status === 'completed').length;
        const processingOrPending = studentsData.filter(s => s.status === 'processing' || s.status === 'pending').length;
        const total = studentsData.length;
        const completedWithScore = studentsData.filter(s => s.status === 'completed' && typeof s.score === 'number');
        const averageScore = completedWithScore.length > 0 
            ? Math.round(completedWithScore.reduce((sum, s) => sum + s.score, 0) / completedWithScore.length) 
            : 0;
        document.getElementById('totalSubmissions').textContent = total;
        document.getElementById('completedAnalyses').textContent = completed;
        document.getElementById('pendingAnalyses').textContent = processingOrPending;
        document.getElementById('averageScore').textContent = averageScore;
    }

    function renderStudentsTable(data = null) {
        const displayData = data || studentsData;
        const container = document.getElementById('studentsTableContainer');
        
        if (displayData.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>Aucune soumission pour le moment</h3><p>Les soumissions des √©tudiants appara√Ætront ici.</p></div>`;
            return;
        }

        const tableHTML = `
            <table class="students-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortTable('name')">üë§ √âtudiant ${getSortIcon('name')}</th>
                        <th>üìã Projet</th>
                        <th class="sortable-header" onclick="sortTable('date')">üìÖ Soumission ${getSortIcon('date')}</th>
                        <th>üìä Statut</th>
                        <th>üéØ Score</th>
                        <th>‚öôÔ∏è Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${displayData.map(student => `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${student.name}</div>
                                <div style="font-size: 0.85em; color: #666;">${student.email}</div>
                            </td>
                            <td><div style="font-weight: 500; max-width: 250px; line-height: 1.4;">${student.project}</div></td>
                            <td>
                                <div>${formatDate(student.submissionDate)}</div>
                                <div style="font-size: 0.85em; color: #666;">${formatTime(student.submissionDate)}</div>
                            </td>
                            <td><span class="status-badge status-${student.status}">${getStatusText(student.status)}</span></td>
                            <td>${student.score !== null ? `<span style="font-weight: 700; color: #4facfe; font-size: 1.1em;">${student.score}/100</span>` : '<span style="color: #999;">En attente</span>'}</td>
                            <td>${student.status === 'completed' ? `<button class="action-btn" onclick="viewReport('${student.id}')">üìã Voir rapport</button>` : `<button class="action-btn secondary" onclick="viewStatus('${student.id}')">üëÄ Statut</button>`}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        container.innerHTML = tableHTML;
    }

    // --- Fonctions helpers (vos fonctions existantes) ---
    function getSortIcon(column) { if (sortColumn !== column) return '‚ÜïÔ∏è'; return sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'; }
    function sortTable(column) { if (sortColumn === column) { sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; } else { sortColumn = column; sortDirection = 'asc'; } let sortedData = [...getFilteredData()]; if (column === 'name') { sortedData.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()) * (sortDirection === 'asc' ? 1 : -1)); } else if (column === 'date') { sortedData.sort((a, b) => (new Date(a.submissionDate) - new Date(b.submissionDate)) * (sortDirection === 'asc' ? 1 : -1)); } renderStudentsTable(sortedData); }
    function getFilteredData() { let filtered = [...studentsData]; const searchQuery = document.getElementById('searchBox').value.toLowerCase(); if (searchQuery) { filtered = filtered.filter(s => s.name.toLowerCase().includes(searchQuery) || s.email.toLowerCase().includes(searchQuery) || s.project.toLowerCase().includes(searchQuery)); } const statusFilter = document.getElementById('statusFilter').value; if (statusFilter && statusFilter !== 'all') { filtered = filtered.filter(s => s.status === statusFilter); } return filtered; }
    function setupEventListeners() { document.getElementById('searchBox').addEventListener('input', () => renderStudentsTable(getFilteredData())); document.getElementById('statusFilter').addEventListener('change', () => renderStudentsTable(getFilteredData())); document.getElementById('logoutButton').addEventListener('click', logout); document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV); document.getElementById('reportModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeReportModal(); }); }
    function formatDate(d) { return new Date(d).toLocaleDateString('fr-CA'); }
    function formatTime(d) { return new Date(d).toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }); }
    function getStatusText(status) { const map = { 'completed': '‚úÖ Termin√©', 'processing': '‚è≥ En cours', 'pending': '‚è∏Ô∏è En attente', 'error': '‚ùå Erreur'}; return map[status] || status; }
    function exportToCSV() { const headers = ['Nom', 'Email', 'Projet', 'Date Soumission', 'Statut', 'Score']; const csvData = [headers.join(',')]; studentsData.forEach(s => { const row = [`"${s.name}"`, `"${s.email}"`, `"${s.project}"`, `"${s.submissionDate}"`, `"${getStatusText(s.status)}"`, s.score || 'N/A']; csvData.push(row.join(',')); }); const blob = new Blob([csvData.join('\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", `export_plans_affaires_${new Date().toISOString().split('T')[0]}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    // ==========================================================
    // POINT D'ENTR√âE AU CHARGEMENT DE LA PAGE
    // ==========================================================
    window.addEventListener('load', function() {
        const token = localStorage.getItem('professorToken');
        if (token) {
            const professorInfo = JSON.parse(localStorage.getItem('professorInfo') || '{}');
            updateUIAfterLogin(professorInfo);
            initializeDashboard();
        }
    });
</script>

</body>
</html>
<script>
    // ==========================================================
    // VARIABLES GLOBALES
    // ==========================================================
    let studentsData = [];
    let sortColumn = null;
    let sortDirection = 'asc';

    // ==========================================================
    // GESTION DE L'AUTHENTIFICATION ET INITIALISATION
    // ==========================================================

    // G√®re le formulaire de connexion
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Email ou mot de passe incorrect');
                }
                
                const data = await response.json();
                
                localStorage.setItem('professorToken', data.access_token);
                localStorage.setItem('professorInfo', JSON.stringify(data.professor || {}));
                
                updateUIAfterLogin(data.professor);
                await initializeDashboard();
                
            } catch (error) {
                console.error('Erreur de connexion:', error);
                alert('Erreur de connexion: ' + error.message);
            }
        });
    }

    // Met √† jour l'interface apr√®s une connexion r√©ussie
    function updateUIAfterLogin(professorInfo) {
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) loginContainer.style.display = 'none';

        const dashboardContainer = document.getElementById('dashboardContainer');
        if (dashboardContainer) dashboardContainer.style.display = 'block';

        const professorName = document.getElementById('professorName');
        if(professorName) professorName.textContent = professorInfo?.name || 'Professeur';
        
        const professorCourse = document.getElementById('professorCourse');
        if(professorCourse) professorCourse.textContent = professorInfo?.course || 'Entrepreneuriat';
    }

    // Fonction principale qui charge les donn√©es du tableau de bord
    async function initializeDashboard() {
        const container = document.getElementById('studentsTableContainer');
        if (!container) {
            console.error("Erreur critique: Le conteneur du tableau 'studentsTableContainer' est introuvable.");
            return;
        }

        try {
            const token = localStorage.getItem('professorToken');
            if (!token) {
                logout();
                return;
            }
            
            const response = await fetch('/api/professor/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Erreur lors du chargement des donn√©es');
            
            const submissionsFromServer = await response.json();
            
            studentsData = submissionsFromServer.map(submission => ({
                id: submission.id,
                name: submission.student_name,
                email: submission.student_email,
                project: submission.project_title,
                status: submission.status,
                submissionDate: submission.submission_date,
                score: submission.score,
                lastActivity: submission.submission_date 
            }));
            
            updateStats();
            renderStudentsTable();
            setupEventListeners(); // Relance les √©couteurs apr√®s le rendu
            
        } catch (error) {
            console.error('Erreur lors du chargement du dashboard:', error);
            container.innerHTML = `<div class="empty-state"><h3>Erreur de chargement</h3><p>${error.message}</p></div>`;
        }
    }

    // ==========================================================
    // GESTION DES RAPPORTS ET DE LA MODALE
    // ==========================================================

    async function viewReport(studentId) {
        const token = localStorage.getItem('professorToken');
        if (!token) {
            alert("Session expir√©e, veuillez vous reconnecter.");
            return;
        }

        const reportModal = document.getElementById('reportModal');
        const reportContent = document.getElementById('reportContent');
        if (!reportModal || !reportContent) return;
        
        reportContent.innerHTML = '<div style="text-align:center; padding: 2rem;">Chargement du rapport...</div>';
        reportModal.style.display = 'flex';

        try {
            const response = await fetch(`/api/analysis/${studentId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Impossible de charger le rapport.');
            }
            const analysis = await response.json();
            reportContent.innerHTML = analysis.report_html;
        } catch (error) {
            console.error("Erreur chargement du rapport:", error);
            reportContent.innerHTML = `<div style="text-align:center; padding: 2rem; color:red;">${error.message}</div>`;
        }
    }

    function viewStatus(studentId) {
        const student = studentsData.find(s => s.id === studentId);
        if (student) {
            alert(`‚è≥ Statut de l'analyse\n\n√âtudiant: ${student.name}\nProjet: ${student.project}\n\nL'analyse par IA est en cours. Le rapport sera disponible dans quelques minutes.`);
        }
    }

    function closeReportModal() {
        const reportModal = document.getElementById('reportModal');
        if (reportModal) reportModal.style.display = 'none';
    }

    // ==========================================================
    // FONCTIONS UTILITAIRES (RENDU, TRI, FILTRE, ETC.)
    // ==========================================================

    function updateStats() {
        const completed = studentsData.filter(s => s.status === 'completed').length;
        const processingOrPending = studentsData.filter(s => s.status === 'processing' || s.status === 'pending').length;
        const total = studentsData.length;
        const completedWithScore = studentsData.filter(s => s.status === 'completed' && typeof s.score === 'number');
        const averageScore = completedWithScore.length > 0 
            ? Math.round(completedWithScore.reduce((sum, s) => sum + s.score, 0) / completedWithScore.length) 
            : 0;

        const totalSubmissionsEl = document.getElementById('totalSubmissions');
        if(totalSubmissionsEl) totalSubmissionsEl.textContent = total;

        const completedAnalysesEl = document.getElementById('completedAnalyses');
        if(completedAnalysesEl) completedAnalysesEl.textContent = completed;
        
        const pendingAnalysesEl = document.getElementById('pendingAnalyses');
        if(pendingAnalysesEl) pendingAnalysesEl.textContent = processingOrPending;

        const averageScoreEl = document.getElementById('averageScore');
        if(averageScoreEl) averageScoreEl.textContent = averageScore;
    }

    function renderStudentsTable(data = null) {
        const displayData = data || studentsData;
        const container = document.getElementById('studentsTableContainer');
        if (!container) return; // S√©curit√©
        
        if (displayData.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>Aucune soumission pour le moment</h3><p>Les soumissions des √©tudiants appara√Ætront ici.</p></div>`;
            return;
        }

        const tableHTML = `
            <table class="students-table">
                <thead>
                    <tr>
                        <th class="sortable-header" onclick="sortTable('name')">üë§ √âtudiant ${getSortIcon('name')}</th>
                        <th>üìã Projet</th>
                        <th class="sortable-header" onclick="sortTable('date')">üìÖ Soumission ${getSortIcon('date')}</th>
                        <th>üìä Statut</th>
                        <th>üéØ Score</th>
                        <th>‚öôÔ∏è Actions</th>
                    </tr>
                </thead>
                <tbody id="submissions-table-body">
                    ${displayData.map(student => `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${student.name}</div>
                                <div style="font-size: 0.85em; color: #666;">${student.email}</div>
                            </td>
                            <td><div style="font-weight: 500; max-width: 250px; line-height: 1.4;">${student.project}</div></td>
                            <td>
                                <div>${formatDate(student.submissionDate)}</div>
                                <div style="font-size: 0.85em; color: #666;">${formatTime(student.submissionDate)}</div>
                            </td>
                            <td><span class="status-badge status-${student.status}">${getStatusText(student.status)}</span></td>
                            <td>${student.score !== null ? `<span style="font-weight: 700; color: #4facfe; font-size: 1.1em;">${student.score}/100</span>` : '<span style="color: #999;">En attente</span>'}</td>
                            <td>${student.status === 'completed' ? `<button class="action-btn" onclick="viewReport('${student.id}')">üìã Voir rapport</button>` : `<button class="action-btn secondary" onclick="viewStatus('${student.id}')">üëÄ Statut</button>`}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        container.innerHTML = tableHTML;
    }
    
    // --- LA FONCTION CORRIG√âE ET S√âCURIS√âE ---
    function setupEventListeners() {
        const searchBox = document.getElementById('searchBox');
        if (searchBox) searchBox.addEventListener('input', () => renderStudentsTable(getFilteredData()));

        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) statusFilter.addEventListener('change', () => renderStudentsTable(getFilteredData()));
        
        const logoutButton = document.getElementById('logoutButton');
        if(logoutButton) logoutButton.addEventListener('click', logout);
        
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        if(exportCsvBtn) exportCsvBtn.addEventListener('click', exportToCSV);
        
        const reportModal = document.getElementById('reportModal');
        if(reportModal) reportModal.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeReportModal(); });
    }

    // --- Fonctions helpers ---
    function getSortIcon(column) { if (sortColumn !== column) return '‚ÜïÔ∏è'; return sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'; }
    function sortTable(column) { if (sortColumn === column) { sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; } else { sortColumn = column; sortDirection = 'asc'; } let sortedData = [...getFilteredData()]; if (column === 'name') { sortedData.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()) * (sortDirection === 'asc' ? 1 : -1)); } else if (column === 'date') { sortedData.sort((a, b) => (new Date(a.submissionDate) - new Date(b.submissionDate)) * (sortDirection === 'asc' ? 1 : -1)); } renderStudentsTable(sortedData); }
    function getFilteredData() { const searchBox = document.getElementById('searchBox'); const statusFilter = document.getElementById('statusFilter'); let filtered = [...studentsData]; const searchQuery = searchBox ? searchBox.value.toLowerCase() : ''; if (searchQuery) { filtered = filtered.filter(s => s.name.toLowerCase().includes(searchQuery) || s.email.toLowerCase().includes(searchQuery) || s.project.toLowerCase().includes(searchQuery)); } const statusValue = statusFilter ? statusFilter.value : ''; if (statusValue && statusValue !== 'all') { filtered = filtered.filter(s => s.status === statusValue); } return filtered; }
    function formatDate(d) { return new Date(d).toLocaleDateString('fr-CA'); }
    function formatTime(d) { return new Date(d).toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }); }
    function getStatusText(status) { const map = { 'completed': '‚úÖ Termin√©', 'processing': '‚è≥ En cours', 'pending': '‚è∏Ô∏è En attente', 'error': '‚ùå Erreur'}; return map[status] || status; }
    function exportToCSV() { const headers = ['Nom', 'Email', 'Projet', 'Date Soumission', 'Statut', 'Score']; const csvData = [headers.join(',')]; studentsData.forEach(s => { const row = [`"${s.name}"`, `"${s.email}"`, `"${s.project}"`, `"${s.submissionDate}"`, `"${getStatusText(s.status)}"`, s.score || 'N/A']; csvData.push(row.join(',')); }); const blob = new Blob([csvData.join('\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", `export_plans_affaires_${new Date().toISOString().split('T')[0]}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    function logout() {
        localStorage.removeItem('professorToken');
        localStorage.removeItem('professorInfo');
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) loginContainer.style.display = 'flex';
        const dashboardContainer = document.getElementById('dashboardContainer');
        if (dashboardContainer) dashboardContainer.style.display = 'none';
        const loginFormEl = document.getElementById('loginForm');
        if(loginFormEl) loginFormEl.reset();
        studentsData = [];
    }
    // ==========================================================
    // POINT D'ENTR√âE AU CHARGEMENT DE LA PAGE
    // ==========================================================
    window.addEventListener('load', function() {
        const token = localStorage.getItem('professorToken');
        if (token) {
            const professorInfo = JSON.parse(localStorage.getItem('professorInfo') || '{}');
            updateUIAfterLogin(professorInfo);
            initializeDashboard();
        }
    });
</script>
